name: Nightly

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight UTC
  workflow_dispatch:

jobs:
  test-nightly:
    name: Test on Nightly Rust
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt -- --check
        continue-on-error: true

      - name: Run clippy
        run: cargo clippy --all-targets --all-features
        continue-on-error: true

      - name: Build
        run: cargo build --verbose --all-features

      - name: Run tests
        run: cargo test --verbose --all-features

      - name: Report status
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nightly build failed on ${new Date().toISOString().split('T')[0]}`,
              body: `The nightly Rust build has failed. Please investigate.\n\nWorkflow: ${context.workflow}\nRun: ${context.runNumber}`,
              labels: ['bug', 'nightly', 'automated']
            })

  check-msrv:
    name: Check Minimum Supported Rust Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust 1.85
        uses: dtolnay/rust-toolchain@1.85.0

      - name: Check with MSRV
        run: cargo check --all-features

      - name: Build with MSRV
        run: cargo build --all-features

      - name: Test with MSRV
        run: cargo test --all-features


