# GitLab CI/CD Pipeline for Armature Framework
# Converted from GitHub Actions workflows

# Global variables
variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: "1"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fast"
  CACHE_COMPRESSION_LEVEL: "fast"

# Define stages
stages:
  - lint
  - test
  - security
  - build
  - benchmark
  - docs
  - release

# Cache configuration
.cargo_cache:
  cache:
    key:
      files:
        - Cargo.lock
    paths:
      - .cargo/registry
      - .cargo/git
      - target/

# Base job template for Rust
.rust_base:
  extends: .cargo_cache
  image: rust:latest
  before_script:
    - rustc --version
    - cargo --version
    - rustup component add rustfmt clippy

# ============================================================================
# LINT STAGE
# ============================================================================

fmt:check:
  extends: .rust_base
  stage: lint
  script:
    - cargo fmt -- --check
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

clippy:
  extends: .rust_base
  stage: lint
  script:
    - cargo clippy --all-targets --all-features -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: false

# ============================================================================
# TEST STAGE
# ============================================================================

# Test matrix for different Rust versions and OS
.test_template:
  extends: .rust_base
  stage: test
  script:
    - cargo build --verbose --all-features
    - cargo test --verbose --all-features
    - cargo test --doc --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

test:stable:linux:
  extends: .test_template
  image: rust:latest
  tags:
    - linux

test:beta:linux:
  extends: .test_template
  image: rustlang/rust:nightly
  before_script:
    - rustup default beta
    - rustc --version
    - cargo --version
  tags:
    - linux
  allow_failure: true

test:nightly:linux:
  extends: .test_template
  image: rustlang/rust:nightly
  tags:
    - linux
  allow_failure: true

# Documentation tests
doc-tests:
  extends: .rust_base
  stage: test
  script:
    - cargo test --doc --all --all-features
    - ./scripts/test-docs.sh
    - echo "Checking for missing documentation..."
    - cargo doc --all --all-features --no-deps 2>&1 | tee doc-warnings.txt
    - |
      if grep -q "warning: missing documentation" doc-warnings.txt; then
        echo "⚠️  Found items without documentation"
        grep "warning: missing documentation" doc-warnings.txt || true
      else
        echo "✅ All public items have documentation"
      fi
  artifacts:
    paths:
      - target/doc/
    expire_in: 30 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

# Examples build
examples:build:
  extends: .rust_base
  stage: test
  script:
    - |
      for example in examples/*.rs; do
        name=$(basename "$example" .rs)
        echo "Building example: $name"
        cargo build --example "$name" --all-features || echo "Failed to build $name"
      done
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# Code coverage
coverage:
  extends: .rust_base
  stage: test
  before_script:
    - rustup component add llvm-tools-preview
    - cargo install cargo-llvm-cov || true
  script:
    - cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
  coverage: '/\d+\.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: lcov.info
    paths:
      - lcov.info
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

# ============================================================================
# SECURITY STAGE
# ============================================================================

security:audit:
  extends: .rust_base
  stage: security
  before_script:
    - cargo install cargo-audit || true
  script:
    - cargo audit
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: false

# GitLab secret detection (built-in)
secret_detection:
  stage: security
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

# GitLab dependency scanning (built-in)
gemnasium-dependency_scanning:
  stage: security
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

# Minimal versions check
minimal-versions:
  extends: .rust_base
  stage: security
  image: rustlang/rust:nightly
  script:
    - cargo update -Z minimal-versions
    - cargo check --all-features
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"
  allow_failure: true

# ============================================================================
# BUILD STAGE
# ============================================================================

build:release:
  extends: .rust_base
  stage: build
  script:
    - cargo build --release --all-features
  artifacts:
    paths:
      - target/release/armature
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

# Build for multiple targets (release only)
.build_cross:
  extends: .cargo_cache
  stage: build
  image: rust:latest
  before_script:
    - rustup target add $TARGET
  script:
    - cargo build --release --target $TARGET --all-features
  artifacts:
    paths:
      - target/$TARGET/release/
    expire_in: 7 days
  rules:
    - if: $CI_COMMIT_TAG

build:linux-x86_64:
  extends: .build_cross
  variables:
    TARGET: x86_64-unknown-linux-gnu

build:linux-musl:
  extends: .build_cross
  variables:
    TARGET: x86_64-unknown-linux-musl
  before_script:
    - apt-get update && apt-get install -y musl-tools
    - rustup target add $TARGET

# ============================================================================
# BENCHMARK STAGE
# ============================================================================

benchmarks:
  extends: .rust_base
  stage: benchmark
  before_script:
    - cargo install cargo-criterion || true
  script:
    - mkdir -p benches
    - |
      if ls benches/*.rs 1> /dev/null 2>&1; then
        cargo bench --all-features
      else
        echo "No benchmarks found yet"
      fi
  artifacts:
    paths:
      - target/criterion/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true

# ============================================================================
# DOCUMENTATION STAGE
# ============================================================================

docs:build:
  extends: .rust_base
  stage: docs
  script:
    - cargo doc --all-features --no-deps
    - echo '<meta http-equiv="refresh" content="0; url=armature">' > target/doc/index.html
  artifacts:
    paths:
      - target/doc/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "main"

# GitLab Pages deployment
# Deploys the Angular documentation website from gh-pages branch
pages:
  stage: docs
  image: node:20
  before_script:
    - corepack enable
    - corepack prepare pnpm@latest --activate
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    # Fetch and checkout gh-pages branch
    - git fetch origin gh-pages
    - git checkout gh-pages
    - cd web
    # Install dependencies
    - pnpm install
    # Build Angular app for production
    - pnpm run build
    - cd ..
    # Prepare public directory for GitLab Pages
    - mkdir -p public
    - cp -r web/dist/web/browser/* public/ 2>/dev/null || cp -r web/dist/web/* public/ || echo "⚠️  Warning: Could not copy build output"
    # Create index redirect if needed
    - test -f public/index.html || echo '<meta http-equiv="refresh" content="0; url=/armature">' > public/index.html
    # Add .nojekyll to disable Jekyll processing
    - touch public/.nojekyll
    # Return to original branch
    - git checkout -
  artifacts:
    paths:
      - public
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_BRANCH == "gh-pages"
  cache:
    key:
      files:
        - web/pnpm-lock.yaml
    paths:
      - web/node_modules/

# ============================================================================
# RELEASE STAGE
# ============================================================================

# Create GitLab release
release:create:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for $CI_COMMIT_TAG"
  release:
    tag_name: $CI_COMMIT_TAG
    name: 'Release $CI_COMMIT_TAG'
    description: |
      # Armature $CI_COMMIT_TAG

      See [CHANGELOG.md](https://gitlab.com/pegasusheavy/armature/-/blob/develop/CHANGELOG.md) for details.

      ## Installation

      ```toml
      [dependencies]
      armature = "$CI_COMMIT_TAG"
      ```
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/

# Publish to crates.io
.publish_crate:
  extends: .rust_base
  stage: release
  script:
    - |
      if [ "$CRATE" = "armature" ]; then
        cd .
      else
        cd $CRATE
      fi
    - cargo publish --token $CARGO_REGISTRY_TOKEN || true
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
  allow_failure: true

publish:armature-core:
  extends: .publish_crate
  variables:
    CRATE: armature-core

publish:armature-macro:
  extends: .publish_crate
  variables:
    CRATE: armature-macro
  needs:
    - publish:armature-core

publish:armature-config:
  extends: .publish_crate
  variables:
    CRATE: armature-config
  needs:
    - publish:armature-core

publish:armature-jwt:
  extends: .publish_crate
  variables:
    CRATE: armature-jwt
  needs:
    - publish:armature-core

publish:armature-graphql:
  extends: .publish_crate
  variables:
    CRATE: armature-graphql
  needs:
    - publish:armature-core

publish:armature-auth:
  extends: .publish_crate
  variables:
    CRATE: armature-auth
  needs:
    - publish:armature-core

publish:armature-angular:
  extends: .publish_crate
  variables:
    CRATE: armature-angular
  needs:
    - publish:armature-core

publish:armature-react:
  extends: .publish_crate
  variables:
    CRATE: armature-react
  needs:
    - publish:armature-core

publish:armature-vue:
  extends: .publish_crate
  variables:
    CRATE: armature-vue
  needs:
    - publish:armature-core

publish:armature-svelte:
  extends: .publish_crate
  variables:
    CRATE: armature-svelte
  needs:
    - publish:armature-core

publish:armature-validation:
  extends: .publish_crate
  variables:
    CRATE: armature-validation
  needs:
    - publish:armature-core

publish:armature-testing:
  extends: .publish_crate
  variables:
    CRATE: armature-testing
  needs:
    - publish:armature-core

publish:armature-openapi:
  extends: .publish_crate
  variables:
    CRATE: armature-openapi
  needs:
    - publish:armature-core

publish:armature-cache:
  extends: .publish_crate
  variables:
    CRATE: armature-cache
  needs:
    - publish:armature-core

publish:armature-cron:
  extends: .publish_crate
  variables:
    CRATE: armature-cron
  needs:
    - publish:armature-core

publish:armature-queue:
  extends: .publish_crate
  variables:
    CRATE: armature-queue
  needs:
    - publish:armature-core

publish:armature-opentelemetry:
  extends: .publish_crate
  variables:
    CRATE: armature-opentelemetry
  needs:
    - publish:armature-core

publish:armature-security:
  extends: .publish_crate
  variables:
    CRATE: armature-security
  needs:
    - publish:armature-core

# Main crate published last
publish:armature:
  extends: .publish_crate
  variables:
    CRATE: armature
  needs:
    - publish:armature-core
    - publish:armature-macro
    - publish:armature-config
    - publish:armature-jwt
    - publish:armature-graphql
    - publish:armature-auth
    - publish:armature-angular
    - publish:armature-react
    - publish:armature-vue
    - publish:armature-svelte
    - publish:armature-validation
    - publish:armature-testing
    - publish:armature-openapi
    - publish:armature-cache
    - publish:armature-cron
    - publish:armature-queue
    - publish:armature-opentelemetry
    - publish:armature-security

# ============================================================================
# SCHEDULED JOBS
# ============================================================================

# Nightly builds (configured via GitLab UI: CI/CD > Schedules)
nightly:build:
  extends: .rust_base
  stage: test
  image: rustlang/rust:nightly
  script:
    - cargo fmt -- --check || true
    - cargo clippy --all-targets --all-features || true
    - cargo build --verbose --all-features
    - cargo test --verbose --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "nightly"
  allow_failure: true

# MSRV check
msrv:check:
  extends: .rust_base
  stage: test
  image: rust:1.85
  script:
    - cargo check --all-features
    - cargo build --all-features
    - cargo test --all-features
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" && $SCHEDULE_TYPE == "nightly"
    - if: $CI_COMMIT_BRANCH == "develop"
  allow_failure: false

# ============================================================================
# INCLUDE ADDITIONAL CI FILES
# ============================================================================

# Include GitLab's security scanning templates
include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

